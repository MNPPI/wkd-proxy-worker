name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test with coverage
        run: pnpm run coverage

  deploy:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Mask domain names
        run: |
          DOMAINS="${{ secrets.DOMAINS }}"
          for domain in ${DOMAINS//,/ }; do
            echo "::add-mask::${domain}"
          done

      - name: Ensure DNS records
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          DOMAINS="${{ secrets.DOMAINS }}"
          API="https://api.cloudflare.com/client/v4"
          AUTH="Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"

          for domain in ${DOMAINS//,/ }; do
            ZONE_ID=$(curl -sf -H "${AUTH}" \
              "${API}/zones?name=${domain}&status=active" | jq -r '.result[0].id')

            if [ "${ZONE_ID}" = "null" ] || [ -z "${ZONE_ID}" ]; then
              echo "::warning::Zone not found for ${domain}, skipping DNS records"
              continue
            fi

            # Ensure root domain has proxied records for .well-known route
            # (email-only domains may not have A/AAAA/CNAME for the root)
            ROOT_RECORDS=$(curl -sf -H "${AUTH}" \
              "${API}/zones/${ZONE_ID}/dns_records?name=${domain}&type=A" \
              | jq -r '.result | length')
            ROOT_AAAA=$(curl -sf -H "${AUTH}" \
              "${API}/zones/${ZONE_ID}/dns_records?name=${domain}&type=AAAA" \
              | jq -r '.result | length')
            ROOT_CNAME=$(curl -sf -H "${AUTH}" \
              "${API}/zones/${ZONE_ID}/dns_records?name=${domain}&type=CNAME" \
              | jq -r '.result | length')

            if [ "${ROOT_RECORDS}" = "0" ] && [ "${ROOT_AAAA}" = "0" ] && [ "${ROOT_CNAME}" = "0" ]; then
              echo "No proxied root record for ${domain}, creating placeholder records"
              curl -sf -X POST -H "${AUTH}" -H "Content-Type: application/json" \
                "${API}/zones/${ZONE_ID}/dns_records" \
                --data "{\"type\":\"A\",\"name\":\"${domain}\",\"content\":\"192.0.2.1\",\"proxied\":true}" \
                | jq '.success'
              curl -sf -X POST -H "${AUTH}" -H "Content-Type: application/json" \
                "${API}/zones/${ZONE_ID}/dns_records" \
                --data "{\"type\":\"AAAA\",\"name\":\"${domain}\",\"content\":\"100::\",\"proxied\":true}" \
                | jq '.success'
            else
              echo "Root domain ${domain} already has proxied records, skipping"
            fi

            # Ensure openpgpkey subdomain CNAME exists
            SUBDOMAIN_EXISTS=$(curl -sf -H "${AUTH}" \
              "${API}/zones/${ZONE_ID}/dns_records?name=openpgpkey.${domain}&type=CNAME" \
              | jq -r '.result | length')

            if [ "${SUBDOMAIN_EXISTS}" != "0" ]; then
              echo "DNS record openpgpkey.${domain} already exists, skipping"
            else
              echo "Creating DNS record openpgpkey.${domain}"
              curl -sf -X POST -H "${AUTH}" -H "Content-Type: application/json" \
                "${API}/zones/${ZONE_ID}/dns_records" \
                --data "{\"type\":\"CNAME\",\"name\":\"openpgpkey.${domain}\",\"content\":\"${domain}\",\"proxied\":true}" \
                | jq '.success'
            fi
          done

      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          DOMAINS="${{ secrets.DOMAINS }}"
          ROUTE_ARGS=""
          for domain in ${DOMAINS//,/ }; do
            ROUTE_ARGS="$ROUTE_ARGS --route openpgpkey.${domain}/*"
            ROUTE_ARGS="$ROUTE_ARGS --route ${domain}/.well-known/openpgpkey/*"
            ROUTE_ARGS="$ROUTE_ARGS --route *.${domain}/.well-known/openpgpkey/*"
          done
          pnpm exec wrangler deploy $ROUTE_ARGS --var "DOMAINS:${DOMAINS}"
